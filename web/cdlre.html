<!DOCTYPE html>
<html>
    <head>
        <title>cdlre - JS-regexp in JS</title>
        <script type='text/javascript' src='lib/common.js'></script>
        <script type='text/javascript' src='generated/unicode.js'></script>
        <script type='text/javascript' src='lib/unicode.js'></script>
        <script type='text/javascript' src='lib/log.js'></script>
        <script type='text/javascript' src='lib/set.js'></script>
        <script type='text/javascript' src='lib/parser.js'></script>
        <script type='text/javascript' src='lib/matcher.js'></script>
        <script type='text/javascript' src='lib/cdlre.js'></script>
        <script type='text/javascript' src='test/cdlre_test.js'></script>
        <script type='text/javascript' src='http://ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js'></script>
        <script type='text/javascript'>
            /*
            function print() {
                var output = document.getElementById('re-output');
                for (var i = 0; i < arguments.length; ++i)
                    output.value += arguments[i];
                output.value += '\n';
            }
            */

            function logStack() {
                try {
                    throw new Error();
                } catch (e) {
                    var lines = e.stack.toString().split(/\n/);
                    for (var i = 0; i < lines.length; ++i)
                        console.log(lines[i]);
                }
            }

            function print() {
                logStack();
            }

            function clearOutput() {
                var output = document.getElementById('re-output');
                output.value = '';
            }

            function getLiteralAndInput() {
                var literalStr = document.getElementById('re-literal').value;
                var inputStr = document.getElementById('re-input').value;
                var opStr = $('#engine-input>form input:radio[name=operation]:checked').val();
                //print('Evaluating literal string: ', literalStr);
                var literal = eval(literalStr);
                return [literal, opStr, inputStr];
            }

            function runRegExp() {
                var tup = getLiteralAndInput();
                console.log(tup);
                var hostRE = tup[0],
                    opStr = tup[1],
                    inputStr = tup[2];
                var guestRE = cdlre.fromHostRE(hostRE);
                var guestResult = guestRE[opStr].call(guestRE, inputStr);
                var outputStr = cdlre.matchToString(guestResult);
                $('#engine-output>textarea').val(outputStr);
            }

            function checkAgainstHost() {
                var tup = getLiteralAndInput();
                var literal = tup[0];
                var input = tup[1];
                try {
                    cdlre.test.checkAgainstHost(literal.source, cdlre.flagsToString(literal), input);
                } catch (e) {
                    if (e.message !== 'failure') {
                        pfmt('{}\n{}', e, e.stack);
                        throw e;
                    }
                }
            }

            function hideButtons() {
                $('#regression-button').hide();
                $('#engine-button').hide();
            }

            function showEngine() {
                hideButtons();
                $('#engine-container').show();
            }

            function runRegression() {
                hideButtons();
                var patternToDiv = {};

                function getOrColorDiv(pattern, isFailure) {
                    if (pattern === undefined)
                        throw new Error();
                    if (!patternToDiv.hasOwnProperty(pattern)) {
                        var div = $('<div class="successful-result result">' + pattern + '</div>');
                        $('#regression-patterns').append(div);
                        patternToDiv[pattern] = div;
                    }
                    var div = patternToDiv[pattern];
                    if (isFailure) {
                        div.removeClass('successful-result').addClass('failed-result');
                        $('#regression-patterns').prepend(div);
                    }
                }

                var results = testCDLRE(function handleResult(data) {
                    var reason = data.reason;
                    if (reason === 'attr') {
                        getOrColorDiv(data.pattern, true);
                    } else if (reason === 'success') {
                        getOrColorDiv(data.pattern, false);
                    } else {
                        throw new Error('NYI: ' + reason);
                    }
                });
                $('#regression-stats').append($('<span>Success: ' + results.successes + '</span><br />'));
                $('#regression-stats').append($('<span>Failure: ' + results.failures + '</span><br />'));
                $('#regression-stats').append($('<span>Host exec time: ' + results.hostExecTime + ' ms</span><br />'));
                $('#regression-stats').append($('<span>Guest exec time: ' + results.guestExecTime + ' ms</span>'));
            }
        </script>
        <style type='text/css'>
            body {
                font-family: Helvetica, Arial, sans-serif;
            }
            .full-textarea textarea {
                font-family: monospace;
                width: 100%;
            }
            #body-container {
                margin-left: auto;
                margin-right: auto;
                text-align: center;
            }
            #button-container {
                margin-top: 200px;
            }
            #engine-button>input {
                font-size: 24pt;
                padding: 10px;
                width: 350px;
            }
            #engine-input table {
                margin-left: auto;
                margin-right: auto;
		text-align: left;
            }
            #engine-input #run-button {
                padding-top: 10px;
                text-align: center;
            }
            #engine-container {
                display: none;
                margin-top: 200px;
            }
            #engine-output {
                margin-top: 30px;
            }
            #engine-output>textarea {
                width: 480px;
                height: 200px;
            }
            #regression-container {
                display: none;
            }
            #regression-button>input {
                font-size: 24pt;
                padding: 10px;
                width: 350px;
            }
            #regression-results {
                width: 500px;
                margin: auto;
            }
            #regression-patterns>div.result {
                padding: 3px;
                margin: 5px;
                font-family: monospace;
            }
            #regression-patterns>div.failed-result {
                background-color: #aa0011;
            }
            #regression-patterns>div.successful-result {
                background-color: #00cc11;
            }
        </style>
    </head>
    <body>
        <div id='body-container'>
            <div id='engine-container'>
                <div id='engine-input'>
                    <form onsubmit='return false'>
                        <table>
                            <tr>
                                <td><label for='source'>RegExp:</label></td>
                                <td><input name='source' id='re-literal' value='/(?:)/' /></td>
                            </tr>
                            <tr>
                                <td><label for='text'>Text:</label></td>
                                <td><input name='text' id='re-input' value='sample input' /></td>
                            </tr>
                            <tr>
                                <td><label for='operation'>Operation:</label></td>
                                <td>
                                    <input name='operation' type='radio' value='exec' checked='yes'>exec</input>
                                    <input name='operation' type='radio' value='test'>test</input>
                                </td>
                            </tr>
                            <tr>
                                <td colspan='2' id='run-button'>
                                    <input type='submit' value='Run' onclick='runRegExp()'></input>
                                </td>
                            </tr>
                        </table>
                    </form>
                </div>
                <div id='engine-output'>
                    <textarea></textarea>
                </div>
            </div>
            <div id='regression-container'>
                <div id='regression-results'>
                    <div id='regression-stats'>
                    </div>
                    <div id='regression-patterns'>
                    </div>
                </div>
            </div>
            <div id='button-container'>
                <div id='regression-button'>
                    <input type='submit' value='RegExp regression' onclick='runRegression(); return false'></input>
                </div>
                <div id='engine-button'>
                    <input type='submit' value='RegExp engine' onclick='showEngine(); return false'></input>
                </div>
            </div>
        </div>
    </body>
</html>
